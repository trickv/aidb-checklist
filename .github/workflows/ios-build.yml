name: iOS Build

on:
  push:
    branches: [ main, master, develop, 'claude/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  ios-build:
    name: Build iOS App
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Show Xcode version
      run: |
        xcodebuild -version
        xcrun --show-sdk-path

    - name: Install CocoaPods
      run: |
        sudo gem install cocoapods
        pod --version

    - name: Install dependencies
      run: npm install

    - name: Cache Pods
      uses: actions/cache@v4
      with:
        path: ios/Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods dependencies
      working-directory: ./ios
      run: |
        pod install --repo-update

    - name: Build iOS for simulator (Debug)
      working-directory: ./ios
      run: |
        set +e
        xcodebuild -workspace ResolutionTracker.xcworkspace \
          -scheme ResolutionTracker \
          -sdk iphonesimulator \
          -configuration Debug \
          -derivedDataPath build \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          build 2>&1 | tee /tmp/xcodebuild-output.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        echo "Build exit code: $BUILD_EXIT_CODE"
        exit $BUILD_EXIT_CODE

    - name: Build iOS for device (Release, unsigned)
      working-directory: ./ios
      run: |
        xcodebuild -workspace ResolutionTracker.xcworkspace \
          -scheme ResolutionTracker \
          -sdk iphoneos \
          -configuration Release \
          -derivedDataPath build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          build
      continue-on-error: true

    - name: Capture build logs on failure
      if: failure()
      run: |
        if [ -f /tmp/xcodebuild-output.log ]; then
          echo "## iOS Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Last 100 lines of build output:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -100 /tmp/xcodebuild-output.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Could not read build output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

    - name: List build outputs
      working-directory: ./ios
      run: |
        echo "=== iOS Build Products ==="
        find build/Build/Products -name "*.app" -type d 2>/dev/null || echo "No .app bundles found"
        echo ""
        echo "=== Build directory structure ==="
        ls -la build/Build/Products/ || echo "Build directory not found"

    - name: Create IPA from Release app bundle
      working-directory: ./ios/build/Build/Products
      run: |
        if [ -d "Release-iphoneos" ] && [ -n "$(find Release-iphoneos -name "*.app" -type d 2>/dev/null)" ]; then
          APP_PATH=$(find Release-iphoneos -name "*.app" -type d | head -1)
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          zip -r ResolutionTracker.ipa Payload/
          rm -rf Payload
          echo "Created Release IPA for AltStore"
          ls -la ResolutionTracker.ipa
        else
          echo "No Release app bundle found, trying Debug..."
          if [ -d "Debug-iphonesimulator" ]; then
            APP_PATH=$(find Debug-iphonesimulator -name "*.app" -type d | head -1)
            if [ -n "$APP_PATH" ]; then
              mkdir -p Payload
              cp -R "$APP_PATH" Payload/
              zip -r ResolutionTracker-simulator.ipa Payload/
              rm -rf Payload
              echo "Created simulator IPA (note: won't work on real device)"
            fi
          fi
        fi
      continue-on-error: true

    - name: Upload iOS Release IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-release-ipa
        path: ios/build/Build/Products/ResolutionTracker.ipa
        if-no-files-found: warn
        retention-days: 30

    - name: Upload iOS Debug Build
      uses: actions/upload-artifact@v4
      with:
        name: ios-debug-app
        path: |
          ios/build/Build/Products/Debug-iphonesimulator/*.app
          ios/build/Build/Products/ResolutionTracker-simulator.ipa
        if-no-files-found: warn
        retention-days: 30

    - name: Upload iOS Release Build
      uses: actions/upload-artifact@v4
      if: success() || failure()
      with:
        name: ios-release-app
        path: ios/build/Build/Products/Release-iphoneos/*.app
        if-no-files-found: ignore
        retention-days: 30
